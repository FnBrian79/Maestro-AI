-- Password Manager Database Schema for SQLite
-- Supports auto-fill with accessibility API integration

-- Main accounts/credentials table
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    username TEXT,
    email TEXT,
    password_encrypted BLOB NOT NULL,
    url TEXT,
    domain TEXT, -- extracted from URL for matching
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_used DATETIME,
    favorite BOOLEAN DEFAULT 0,
    tags TEXT -- JSON array of tags
);

-- Form field mappings for auto-fill
CREATE TABLE form_fields (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id INTEGER NOT NULL,
    field_name TEXT NOT NULL, -- input name/id
    field_type TEXT NOT NULL, -- username, password, email, text, etc.
    field_selector TEXT, -- CSS selector or accessibility identifier
    field_value_encrypted BLOB,
    auto_fill_enabled BOOLEAN DEFAULT 1,
    FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
);

-- Domain/URL patterns for smart matching
CREATE TABLE domain_patterns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id INTEGER NOT NULL,
    pattern TEXT NOT NULL, -- URL pattern or domain
    match_type TEXT DEFAULT 'exact', -- exact, contains, regex
    priority INTEGER DEFAULT 1,
    FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
);

-- Auto-fill sessions and usage tracking
CREATE TABLE autofill_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id INTEGER NOT NULL,
    domain TEXT NOT NULL,
    window_title TEXT,
    app_name TEXT,
    fields_filled TEXT, -- JSON array of filled fields
    success BOOLEAN DEFAULT 1,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);

-- Accessibility element cache for faster matching
CREATE TABLE ui_elements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    domain TEXT NOT NULL,
    app_name TEXT,
    element_type TEXT NOT NULL, -- input, button, form
    element_id TEXT,
    element_name TEXT,
    element_role TEXT, -- accessibility role
    element_path TEXT, -- accessibility tree path
    confidence_score REAL DEFAULT 0.5,
    last_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
    field_type TEXT -- predicted field type
);

-- Security and encryption metadata
CREATE TABLE security_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    master_password_hash TEXT NOT NULL,
    salt TEXT NOT NULL,
    encryption_method TEXT DEFAULT 'AES-256-GCM',
    key_derivation TEXT DEFAULT 'PBKDF2',
    iterations INTEGER DEFAULT 100000,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Auto-fill rules and preferences
CREATE TABLE autofill_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_name TEXT NOT NULL,
    domain_pattern TEXT,
    app_pattern TEXT,
    field_mapping TEXT NOT NULL, -- JSON mapping rules
    enabled BOOLEAN DEFAULT 1,
    priority INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Small language model context storage
CREATE TABLE ml_context (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    context_type TEXT NOT NULL, -- form_analysis, field_prediction, etc.
    input_data TEXT NOT NULL, -- JSON input for model
    output_data TEXT, -- JSON model output
    confidence REAL,
    model_version TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for performance
CREATE INDEX idx_accounts_domain ON accounts(domain);
CREATE INDEX idx_accounts_url ON accounts(url);
CREATE INDEX idx_form_fields_account ON form_fields(account_id);
CREATE INDEX idx_domain_patterns_account ON domain_patterns(account_id);
CREATE INDEX idx_autofill_sessions_account ON autofill_sessions(account_id);
CREATE INDEX idx_autofill_sessions_domain ON autofill_sessions(domain);
CREATE INDEX idx_ui_elements_domain ON ui_elements(domain);
CREATE INDEX idx_ui_elements_app ON ui_elements(app_name);

-- Triggers for updating timestamps
CREATE TRIGGER update_accounts_timestamp 
    AFTER UPDATE ON accounts
    BEGIN
        UPDATE accounts SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
    END;

CREATE TRIGGER update_last_used
    AFTER INSERT ON autofill_sessions
    BEGIN
        UPDATE accounts SET last_used = CURRENT_TIMESTAMP WHERE id = NEW.account_id;
    END;